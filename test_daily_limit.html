<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥é™åˆ¶åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: inline-block;
            width: 80px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ æ¯æ—¥é™åˆ¶åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h3>1. åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
        <div class="form-group">
            <label>å·¥å·:</label>
            <input type="text" id="testEmployeeId" value="12345" placeholder="è¾“å…¥å·¥å·">
        </div>
        <div class="form-group">
            <label>å§“å:</label>
            <input type="text" id="testEmployeeName" value="æµ‹è¯•ç”¨æˆ·" placeholder="è¾“å…¥å§“å">
        </div>
        <button onclick="testBasicFunctions()">æµ‹è¯•åŸºç¡€åŠŸèƒ½</button>
        <div id="basicTestResult"></div>
    </div>

    <div class="test-section">
        <h3>2. æ¯æ—¥é™åˆ¶æµ‹è¯•</h3>
        <button onclick="testDailyLimit()">æµ‹è¯•æ¯æ—¥é™åˆ¶æ£€æŸ¥</button>
        <button onclick="testRecordGame()">æµ‹è¯•è®°å½•æ¸¸æˆ</button>
        <button onclick="testLimitAfterRecord()">æµ‹è¯•è®°å½•åé™åˆ¶</button>
        <div id="limitTestResult"></div>
    </div>

    <div class="test-section">
        <h3>3. æ•°æ®ç®¡ç†æµ‹è¯•</h3>
        <button onclick="testDataManagement()">æµ‹è¯•æ•°æ®ç®¡ç†</button>
        <button onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <div id="dataTestResult"></div>
    </div>

    <div class="test-section">
        <h3>4. æ—¶åŒºæµ‹è¯•</h3>
        <button onclick="testTimezone()">æµ‹è¯•æ—¶åŒºè®¡ç®—</button>
        <div id="timezoneTestResult"></div>
    </div>

    <div class="test-section">
        <h3>5. å®Œæ•´æµç¨‹æµ‹è¯•</h3>
        <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="completeTestResult"></div>
    </div>

    <script>
        // æ¯æ—¥é™åˆ¶ç®¡ç†å™¨ï¼ˆå¤åˆ¶è‡ªä¸»æ¸¸æˆï¼‰
        class DailyLimitManager {
            constructor() {
                this.gameId = 'game2';
                this.storageKey = 'daily_limit_data';
            }

            getChinaToday() {
                const now = new Date();
                const chinaTime = new Intl.DateTimeFormat('en-CA', {
                    timeZone: 'Asia/Shanghai',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).format(now);
                return chinaTime;
            }

            getUserKey(employeeId, employeeName) {
                return `${employeeId}_${employeeName}`;
            }

            getData() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    const parsed = data ? JSON.parse(data) : { users: {} };
                    
                    if (!parsed.users || typeof parsed.users !== 'object') {
                        return { users: {} };
                    }
                    
                    return parsed;
                } catch (error) {
                    console.error('è·å–æœ¬åœ°æ•°æ®å¤±è´¥:', error);
                    return { users: {} };
                }
            }

            saveData(data) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜æœ¬åœ°æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }

            checkDailyLimit(employeeId, employeeName) {
                const userKey = this.getUserKey(employeeId, employeeName);
                const today = this.getChinaToday();
                
                try {
                    const data = this.getData();
                    const user = data.users[userKey];
                    
                    if (user && user.lastPlayDate === today) {
                        return {
                            canPlay: false,
                            reason: 'ä»Šæ—¥å·²ç©è¿‡æ¸¸æˆï¼Œè¯·æ˜å¤©00:00åå†è¯•ï¼',
                            playedGames: user.games || {}
                        };
                    }
                    
                    return { canPlay: true };
                } catch (error) {
                    console.error('æ£€æŸ¥æ¯æ—¥é™åˆ¶å¤±è´¥:', error);
                    return { canPlay: true };
                }
            }

            recordGamePlay(employeeId, employeeName) {
                const userKey = this.getUserKey(employeeId, employeeName);
                const today = this.getChinaToday();
                
                try {
                    const data = this.getData();
                    
                    if (!data.users[userKey]) {
                        data.users[userKey] = {
                            lastPlayDate: today,
                            games: {}
                        };
                    }
                    
                    data.users[userKey].lastPlayDate = today;
                    data.users[userKey].games[this.gameId] = true;
                    
                    const success = this.saveData(data);
                    return success;
                } catch (error) {
                    console.error('è®°å½•æ¸¸æˆå¤±è´¥:', error);
                    return false;
                }
            }
        }

        const manager = new DailyLimitManager();

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        function testBasicFunctions() {
            const employeeId = document.getElementById('testEmployeeId').value;
            const employeeName = document.getElementById('testEmployeeName').value;
            
            if (!employeeId || !employeeName) {
                showResult('basicTestResult', 'è¯·è¾“å…¥å·¥å·å’Œå§“å', 'error');
                return;
            }

            const today = manager.getChinaToday();
            const userKey = manager.getUserKey(employeeId, employeeName);
            
            let result = `âœ… æ—¶åŒºè®¡ç®—: ${today}<br>`;
            result += `âœ… ç”¨æˆ·æ ‡è¯†: ${userKey}<br>`;
            result += `âœ… æ•°æ®è·å–: ${JSON.stringify(manager.getData())}<br>`;
            
            showResult('basicTestResult', result, 'success');
        }

        function testDailyLimit() {
            const employeeId = document.getElementById('testEmployeeId').value;
            const employeeName = document.getElementById('testEmployeeName').value;
            
            if (!employeeId || !employeeName) {
                showResult('limitTestResult', 'è¯·è¾“å…¥å·¥å·å’Œå§“å', 'error');
                return;
            }

            const check = manager.checkDailyLimit(employeeId, employeeName);
            
            let result = `æ£€æŸ¥ç»“æœ: ${check.canPlay ? 'âœ… å¯ä»¥æ¸¸æˆ' : 'âŒ ä¸èƒ½æ¸¸æˆ'}<br>`;
            if (!check.canPlay) {
                result += `é™åˆ¶åŸå› : ${check.reason}<br>`;
                result += `å·²ç©æ¸¸æˆ: ${JSON.stringify(check.playedGames)}<br>`;
            }
            
            showResult('limitTestResult', result, check.canPlay ? 'success' : 'info');
        }

        function testRecordGame() {
            const employeeId = document.getElementById('testEmployeeId').value;
            const employeeName = document.getElementById('testEmployeeName').value;
            
            if (!employeeId || !employeeName) {
                showResult('limitTestResult', 'è¯·è¾“å…¥å·¥å·å’Œå§“å', 'error');
                return;
            }

            const success = manager.recordGamePlay(employeeId, employeeName);
            
            let result = `è®°å½•ç»“æœ: ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}<br>`;
            result += `å½“å‰æ•°æ®: ${JSON.stringify(manager.getData())}<br>`;
            
            showResult('limitTestResult', result, success ? 'success' : 'error');
        }

        function testLimitAfterRecord() {
            const employeeId = document.getElementById('testEmployeeId').value;
            const employeeName = document.getElementById('testEmployeeName').value;
            
            if (!employeeId || !employeeName) {
                showResult('limitTestResult', 'è¯·è¾“å…¥å·¥å·å’Œå§“å', 'error');
                return;
            }

            const check = manager.checkDailyLimit(employeeId, employeeName);
            
            let result = `è®°å½•åæ£€æŸ¥: ${check.canPlay ? 'âŒ åº”è¯¥è¢«é™åˆ¶' : 'âœ… æ­£ç¡®è¢«é™åˆ¶'}<br>`;
            if (!check.canPlay) {
                result += `é™åˆ¶åŸå› : ${check.reason}<br>`;
            }
            
            showResult('limitTestResult', result, check.canPlay ? 'error' : 'success');
        }

        function testDataManagement() {
            const data = manager.getData();
            const userCount = Object.keys(data.users).length;
            
            let result = `ç”¨æˆ·æ•°é‡: ${userCount}<br>`;
            result += `å­˜å‚¨é”®: ${manager.storageKey}<br>`;
            result += `æ¸¸æˆID: ${manager.gameId}<br>`;
            result += `å®Œæ•´æ•°æ®: <pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            showResult('dataTestResult', result, 'info');
        }

        function clearAllData() {
            localStorage.removeItem(manager.storageKey);
            showResult('dataTestResult', 'âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
        }

        function testTimezone() {
            const now = new Date();
            const chinaTime = manager.getChinaToday();
            const localTime = now.toISOString().split('T')[0];
            
            let result = `æœ¬åœ°æ—¶é—´: ${localTime}<br>`;
            result += `ä¸­å›½æ—¶åŒº: ${chinaTime}<br>`;
            result += `æ—¶åŒºå·®å¼‚: ${chinaTime !== localTime ? 'å­˜åœ¨å·®å¼‚' : 'æ— å·®å¼‚'}<br>`;
            
            showResult('timezoneTestResult', result, 'info');
        }

        function testCompleteFlow() {
            const employeeId = document.getElementById('testEmployeeId').value;
            const employeeName = document.getElementById('testEmployeeName').value;
            
            if (!employeeId || !employeeName) {
                showResult('completeTestResult', 'è¯·è¾“å…¥å·¥å·å’Œå§“å', 'error');
                return;
            }

            // æ¸…ç©ºæ•°æ®å¼€å§‹æµ‹è¯•
            localStorage.removeItem(manager.storageKey);
            
            let result = 'ğŸ”„ å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•<br><br>';
            
            // 1. ç¬¬ä¸€æ¬¡æ£€æŸ¥ - åº”è¯¥å…è®¸
            const check1 = manager.checkDailyLimit(employeeId, employeeName);
            result += `1. ç¬¬ä¸€æ¬¡æ£€æŸ¥: ${check1.canPlay ? 'âœ… å…è®¸' : 'âŒ ä¸å…è®¸'}<br>`;
            
            // 2. è®°å½•æ¸¸æˆ
            const record = manager.recordGamePlay(employeeId, employeeName);
            result += `2. è®°å½•æ¸¸æˆ: ${record ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}<br>`;
            
            // 3. ç¬¬äºŒæ¬¡æ£€æŸ¥ - åº”è¯¥é™åˆ¶
            const check2 = manager.checkDailyLimit(employeeId, employeeName);
            result += `3. ç¬¬äºŒæ¬¡æ£€æŸ¥: ${check2.canPlay ? 'âŒ åº”è¯¥è¢«é™åˆ¶' : 'âœ… æ­£ç¡®è¢«é™åˆ¶'}<br>`;
            
            // 4. éªŒè¯æ•°æ®
            const data = manager.getData();
            const userKey = manager.getUserKey(employeeId, employeeName);
            const user = data.users[userKey];
            result += `4. æ•°æ®éªŒè¯: ${user ? 'âœ… ç”¨æˆ·æ•°æ®å­˜åœ¨' : 'âŒ ç”¨æˆ·æ•°æ®ä¸å­˜åœ¨'}<br>`;
            if (user) {
                result += `   æœ€åæ¸¸æˆæ—¥æœŸ: ${user.lastPlayDate}<br>`;
                result += `   å·²ç©æ¸¸æˆ: ${JSON.stringify(user.games)}<br>`;
            }
            
            // åˆ¤æ–­æµ‹è¯•ç»“æœ
            const testPassed = check1.canPlay && record && !check2.canPlay && user;
            result += `<br>ğŸ¯ æµ‹è¯•ç»“æœ: ${testPassed ? 'âœ… å…¨éƒ¨é€šè¿‡' : 'âŒ å­˜åœ¨é—®é¢˜'}`;
            
            showResult('completeTestResult', result, testPassed ? 'success' : 'error');
        }
    </script>
</body>
</html>
